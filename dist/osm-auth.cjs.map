{
  "version": 3,
  "sources": ["../src/osm-auth.mjs"],
  "sourcesContent": ["import ohauth from 'ohauth';\nimport store from 'store';\n\n\n// # osm-auth\n//\n// This code is only compatible with IE10+ because the [XDomainRequest](http://bit.ly/LfO7xo)\n// object, IE<10's idea of [CORS](http://en.wikipedia.org/wiki/Cross-origin_resource_sharing),\n// does not support custom headers, which this uses everywhere.\nexport function osmAuth(o) {\n  var oauth = {};\n\n  oauth.authenticated = function () {\n    return !!token('access_token');\n  };\n\n  oauth.logout = function () {\n    token('access_token', '');\n    return oauth;\n  };\n\n  // TODO: detect lack of click event\n  oauth.authenticate = function (callback) {\n    if (oauth.authenticated()) return callback();\n\n    oauth.logout();\n\n    // ## Request authorization to access resources from the user\n    // and receive authorization code\n    var url =\n      o.url +\n      '/oauth2/authorize?' +\n      ohauth.qsString({\n        client_id: o.client_id,\n        redirect_uri: o.redirect_uri,\n        response_type: 'code',\n        scope: o.scope,\n      });\n\n    if (!o.singlepage) {\n      // Create a 600x550 popup window in the center of the screen\n      var w = 600;\n      var h = 550;\n      var settings = [\n          ['width', w],\n          ['height', h],\n          ['left', screen.width / 2 - w / 2],\n          ['top', screen.height / 2 - h / 2],\n        ]\n          .map(function (x) {\n            return x.join('=');\n          })\n          .join(',');\n      var popup = window.open('about:blank', 'oauth_window', settings);\n      oauth.popupWindow = popup;\n      popup.location = url;\n\n      if (!popup) {\n        var error = new Error('Popup was blocked');\n        error.status = 'popup-blocked';\n        throw error;\n      }\n    }\n\n    // Called by a function in the redirect URL page, in the popup window. The\n    // window closes itself.\n    window.authComplete = function (url) {\n      var params = ohauth.stringQs(url.split('?')[1]);\n      get_access_token(params.code);\n      delete window.authComplete;\n    };\n\n    // ## Getting an access token\n    //\n    // The client requests an access token by authenticating with the\n    // authorization server and presenting the `auth_code`, brought\n    // in from a function call on a landing page popup.\n    function get_access_token(auth_code) {\n      var url =\n        o.url +\n        '/oauth2/token?' +\n        ohauth.qsString({\n          client_id: o.client_id,\n          grant_type: 'authorization_code',\n          code: auth_code,\n          redirect_uri: o.redirect_uri,\n          client_secret: o.client_secret,\n        });\n\n      // The authorization server authenticates the client and validates\n      // the authorization grant, and if valid, issues an access token.\n      ohauth.xhr('POST', url, null, null, {}, accessTokenDone);\n      o.loading();\n    }\n\n    function accessTokenDone(err, xhr) {\n      o.done();\n      if (err) return callback(err);\n      var access_token = JSON.parse(xhr.response);\n      token('access_token', access_token.access_token);\n      callback(null, oauth);\n    }\n  };\n\n  oauth.bringPopupWindowToFront = function () {\n    var brougtPopupToFront = false;\n    try {\n      // This may cause a cross-origin error:\n      // `DOMException: Blocked a frame with origin \"...\" from accessing a cross-origin frame.`\n      if (oauth.popupWindow && !oauth.popupWindow.closed) {\n        oauth.popupWindow.focus();\n        brougtPopupToFront = true;\n      }\n    } catch (err) {\n      // Bringing popup window to front failed (probably because of the cross-origin error mentioned above)\n    }\n    return brougtPopupToFront;\n  };\n\n  oauth.bootstrapToken = function (auth_code, callback) {\n    // ## Getting an access token\n    // The client requests an access token by authenticating with the\n    // authorization server and presenting the authorization_code\n    function get_access_token(auth_code) {\n      var url =\n        o.url +\n        '/oauth2/token?' +\n        ohauth.qsString({\n          client_id: o.client_id,\n          grant_type: 'authorization_code',\n          code: auth_code,\n          redirect_uri: o.redirect_uri,\n          client_secret: o.client_secret,\n        });\n\n      // The authorization server authenticates the client and validates\n      // the authorization grant, and if valid, issues an access token.\n      ohauth.xhr('POST', url, null, null, {}, accessTokenDone);\n      o.loading();\n    }\n\n    function accessTokenDone(err, xhr) {\n      o.done();\n      if (err) return callback(err);\n      var access_token = JSON.parse(xhr.response);\n      token('access_token', access_token.access_token);\n      callback(null, oauth);\n    }\n\n    get_access_token(auth_code);\n  };\n\n  // # xhr\n  //\n  // A single XMLHttpRequest wrapper that does authenticated calls if the\n  // user has logged in.\n  oauth.xhr = function (options, callback) {\n    if (!oauth.authenticated()) {\n      if (o.auto) {\n        return oauth.authenticate(run);\n      } else {\n        callback('not authenticated', null);\n        return;\n      }\n    } else {\n      return run();\n    }\n\n    function run() {\n      var url = options.prefix !== false ? o.url + options.path : options.path;\n      return ohauth.xhr(\n        options.method,\n        url,\n        token('access_token'),\n        options.content,\n        options.options,\n        done\n      );\n    }\n\n    function done(err, xhr) {\n      if (err) return callback(err);\n      else if (xhr.responseXML) return callback(err, xhr.responseXML);\n      else return callback(err, xhr.response);\n    }\n  };\n\n  // pre-authorize this object, if we can just get an access token from the start\n  oauth.preauth = function (c) {\n    if (!c) return;\n    if (c.access_token) token('access_token', c.access_token);\n    return oauth;\n  };\n\n  oauth.options = function (_) {\n    if (!arguments.length) return o;\n\n    o = _;\n    o.url = o.url || 'https://www.openstreetmap.org';\n    o.singlepage = o.singlepage || false;\n\n    // Optional loading and loading-done functions for nice UI feedback.\n    // by default, no-ops\n    o.loading = o.loading || function () {};\n    o.done = o.done || function () {};\n    return oauth.preauth(o);\n  };\n\n  // get/set tokens. These are prefixed with the base URL so that `osm-auth`\n  // can be used with multiple APIs and the keys in `localStorage`\n  // will not clash\n  var token;\n\n  if (store.enabled) {\n    token = function (x, y) {\n      if (arguments.length === 1) return store.get(o.url + x);\n      else if (arguments.length === 2) return store.set(o.url + x, y);\n    };\n  } else {\n    var storage = {};\n    token = function (x, y) {\n      if (arguments.length === 1) return storage[o.url + x];\n      else if (arguments.length === 2) return (storage[o.url + x] = y);\n    };\n  }\n\n  // potentially pre-authorize\n  oauth.options(o);\n\n  return oauth;\n}"],
  "mappings": "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",
  "names": []
}
